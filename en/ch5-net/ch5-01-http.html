
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>5.1 XMLHttpRequest - WebAssembly friendly programming with C/C++ - 开源图书(OpenBook)</title>
        <meta name="description" content="">
        
        
        
    
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitbook-plugin-theme-default@1.0.7/_assets/website/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="//cdn.jsdelivr.net/npm/gitbook-plugin-theme-default@1.0.7/_assets/website/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="//cdn.jsdelivr.net/npm/gitbook-plugin-theme-default@1.0.7/_assets/website/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="ch5-02-websocket.html" />
    
    
    <link rel="prev" href="readme.html" />
    

        <script src="https://cdn.jsdelivr.net/gh/liuxfe/assets/main.min.js"></script>
    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../ch1-quick-guide/readme.html">
            
                <a href="../ch1-quick-guide/readme.html">
            
                    
                    Chapter 1 Getting started with Emscripten
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../ch1-quick-guide/ch1-01-install.html">
            
                <a href="../ch1-quick-guide/ch1-01-install.html">
            
                    
                    1.1 Installing Emscripten
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../ch1-quick-guide/ch1-02-helloworld.html">
            
                <a href="../ch1-quick-guide/ch1-02-helloworld.html">
            
                    
                    1.2 Hello, world!
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../ch1-quick-guide/ch1-03-glue-code.html">
            
                <a href="../ch1-quick-guide/ch1-03-glue-code.html">
            
                    
                    1.3 Taking a look at the Emscripten glue code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../ch1-quick-guide/ch1-04-compile.html">
            
                <a href="../ch1-quick-guide/ch1-04-compile.html">
            
                    
                    1.4 Selecting compilation target
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../ch2-c-js/readme.html">
            
                <a href="../ch2-c-js/readme.html">
            
                    
                    Chapter 2 Connecting C and JavaScript
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../ch2-c-js/ch2-01-js-call-c.html">
            
                <a href="../ch2-c-js/ch2-01-js-call-c.html">
            
                    
                    2.1 Calling compiled C functions from JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../ch2-c-js/ch2-02-implement-c-api-in-js.html">
            
                <a href="../ch2-c-js/ch2-02-implement-c-api-in-js.html">
            
                    
                    2.2 Implement C API in JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../ch2-c-js/ch2-03-mem-model.html">
            
                <a href="../ch2-c-js/ch2-03-mem-model.html">
            
                    
                    2.3 Memory model
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../ch2-c-js/ch2-04-data-exchange.html">
            
                <a href="../ch2-c-js/ch2-04-data-exchange.html">
            
                    
                    2.4 Exchange data between C and JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../ch2-c-js/ch2-05-em-asm.html">
            
                <a href="../ch2-c-js/ch2-05-em-asm.html">
            
                    
                    2.5 Using EM_ASM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../ch2-c-js/ch2-06-run-script.html">
            
                <a href="../ch2-c-js/ch2-06-run-script.html">
            
                    
                    2.6 Using emscripten_run_script
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../ch2-c-js/ch2-07-ccall-cwrap.html">
            
                <a href="../ch2-c-js/ch2-07-ccall-cwrap.html">
            
                    
                    2.7 Using ccall/cwrap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../ch2-c-js/ch2-08-ext.html">
            
                <a href="../ch2-c-js/ch2-08-ext.html">
            
                    
                    2.8 Supplement
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../ch3-runtime/readme.html">
            
                <a href="../ch3-runtime/readme.html">
            
                    
                    Chapter 3 Emscripten runtime
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../ch3-runtime/ch3-01-main.html">
            
                <a href="../ch3-runtime/ch3-01-main.html">
            
                    
                    3.1 Runtime lifecycle
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../ch3-runtime/ch3-02-message-loop.html">
            
                <a href="../ch3-runtime/ch3-02-message-loop.html">
            
                    
                    3.2 Message loop
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../ch3-runtime/ch3-03-fs.html">
            
                <a href="../ch3-runtime/ch3-03-fs.html">
            
                    
                    3.3 File system
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../ch3-runtime/ch3-04-mem.html">
            
                <a href="../ch3-runtime/ch3-04-mem.html">
            
                    
                    3.4 Memory management
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../ch3-runtime/ch3-05-module.html">
            
                <a href="../ch3-runtime/ch3-05-module.html">
            
                    
                    3.5 Customize Module object
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../ch3-runtime/ch3-06-summary.html">
            
                <a href="../ch3-runtime/ch3-06-summary.html">
            
                    
                    3.6 Summary
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../ch4-techniques/readme.html">
            
                <a href="../ch4-techniques/readme.html">
            
                    
                    Chapter 4 General techniques that WebAssembly friendly
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../ch4-techniques/ch4-01-msg-loop-detach.html">
            
                <a href="../ch4-techniques/ch4-01-msg-loop-detach.html">
            
                    
                    4.1 Message loop detaching
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../ch4-techniques/ch4-02-align.html">
            
                <a href="../ch4-techniques/ch4-02-align.html">
            
                    
                    4.2 Memory alignment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../ch4-techniques/ch4-03-export-obj.html">
            
                <a href="../ch4-techniques/ch4-03-export-obj.html">
            
                    
                    4.3 Exporting C++ objects using the C interface
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../ch4-techniques/ch4-04-obj-life-cycle.html">
            
                <a href="../ch4-techniques/ch4-04-obj-life-cycle.html">
            
                    
                    4.4 Lifecycle control for C++ object
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../ch4-techniques/ch4-05-import-js-obj.html">
            
                <a href="../ch4-techniques/ch4-05-import-js-obj.html">
            
                    
                    4.5 Importing JavaScript object using C interface
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="../ch4-techniques/ch4-06-int64-issue.html">
            
                <a href="../ch4-techniques/ch4-06-int64-issue.html">
            
                    
                    4.6 Be careful with int64
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="../ch4-techniques/ch4-07-forget-about-fs.html">
            
                <a href="../ch4-techniques/ch4-07-forget-about-fs.html">
            
                    
                    4.7 Forget about filesystem
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="readme.html">
            
                <a href="readme.html">
            
                    
                    Chapter 5 Network IO
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.6.1" data-path="ch5-01-http.html">
            
                <a href="ch5-01-http.html">
            
                    
                    5.1 XMLHttpRequest
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="ch5-02-websocket.html">
            
                <a href="ch5-02-websocket.html">
            
                    
                    5.2 WebSocket
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../ch6-threads/readme.html">
            
                <a href="../ch6-threads/readme.html">
            
                    
                    Chapter 6 Multithreading
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../ch6-threads/ch6-01-worker.html">
            
                <a href="../ch6-threads/ch6-01-worker.html">
            
                    
                    6.1 Multithreading in JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../ch6-threads/ch6-02-sample.html">
            
                <a href="../ch6-threads/ch6-02-sample.html">
            
                    
                    6.2 Using Emscripten in Web Worker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../ch7-gui/readme.html">
            
                <a href="../ch7-gui/readme.html">
            
                    
                    Chapter 7 GUI
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../ch7-gui/ch7-01-canvas.html">
            
                <a href="../ch7-gui/ch7-01-canvas.html">
            
                    
                    7.1 Canvas
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../ch7-gui/ch7-02-mouse.html">
            
                <a href="../ch7-gui/ch7-02-mouse.html">
            
                    
                    7.2 Mouse events
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../ch7-gui/ch7-03-keyboard.html">
            
                <a href="../ch7-gui/ch7-03-keyboard.html">
            
                    
                    7.3 Keyboard events
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../ch7-gui/ch7-04-life.html">
            
                <a href="../ch7-gui/ch7-04-life.html">
            
                    
                    7.4 Conway's Game of Life
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://book.liuxfe.com" target="blank" class="gitbook-link">
            <strong>开源图书(OpenBook)</strong>
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    <a href="/" class="btn pull-left" aria-label="开源图书(OpenBook)"><i class="fa fa-home"></i></a>
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >5.1 XMLHttpRequest</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9312750344484857"
     data-ad-slot="3407167863"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                                <section class="normal markdown-section">
                                
                                <h1 id="51-xmlhttprequest">5.1 XMLHttpRequest</h1>
<p>The HTTP protocol is the most commonly used transport protocol in web page. This section describes the use of the <code>XMLHttpRequest</code> object in Emscripten for data transfer.</p>
<h2 id="511-introduction-to-xmlhttprequest-object">5.1.1 Introduction to <code>XMLHttpRequest</code> object</h2>
<p>The following JavaScript code is an example of getting HTTP data using the <code>XMLHttpRequest</code> object:</p>
<pre><code class="lang-js">    <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> XMLHttpRequest();
    request.open(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;t1.txt&quot;</span>, <span class="hljs-literal">true</span>);
    request.responseType = <span class="hljs-string">&quot;text&quot;</span>;    
    request.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">if</span> (request.readyState == <span class="hljs-number">4</span>) {
            <span class="hljs-keyword">if</span> (request.status == <span class="hljs-number">200</span>) {
                <span class="hljs-built_in">console</span>.log(request.responseText);
            }
            <span class="hljs-keyword">else</span>{
                <span class="hljs-built_in">console</span>.log(request.statusText);
            }
        }
    };
    request.send();
</code></pre>
<p>The code above creates an <code>XMLHttpRequest</code> object <code>request</code>, uses the asynchronous <code>GET</code> method to get the data of the remote <em>t1.txt</em>, and prints the obtained string by setting the <code>onreadystatechange</code> callback event. Browse the page, the console output is as follows:</p>
<p><img src="images/01-xhr-js.png" alt=""></p>
<blockquote>
<p><strong>info</strong>  For more details about <code>XMLHttpRequest</code>, please refer to<a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest" target="_blank">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest</a></p>
</blockquote>
<h2 id="512-wrapping-xmlhttprequest-object-using-c-api">5.1.2 Wrapping <code>XMLHttpRequest</code> object using C API</h2>
<p>In order to avoid the UI hang, we usually use the asynchronous mode to initiate the HTTP request, so the C API of the <code>XMLHttpRequest</code> object is divided into two parts:</p>
<ol>
<li>Functions that called by C, implemented by JavaScript. Including the creation of the <code>XMLHttpRequest</code> object, the initiation of HTTP requests etc.</li>
<li>Functions that called by JavaScript, implemented by C. Includes callback functions for various events.</li>
</ol>
<p>Let&apos;s look at the C code first:</p>
<pre><code class="lang-c"><span class="hljs-comment">//xhr_wrap1.cpp</span>

<span class="hljs-comment">//imp by JavaScript, call by C:</span>
EM_PORT_API(<span class="hljs-keyword">void</span>) XHRGet(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url);

<span class="hljs-comment">//imp by C, call by JavaScript:</span>
EM_PORT_API(<span class="hljs-keyword">void</span>) XHROnMessage(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* data){
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;http request succeeded. URL: %s  contex: %s\n&quot;</span>, url, data);
}

EM_PORT_API(<span class="hljs-keyword">void</span>) XHROnError(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> error_code){
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;http request failed. URL: %s  error code:%d\n&quot;</span>, url, error_code);
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    XHRGet(<span class="hljs-string">&quot;t1.txt&quot;</span>);
    XHRGet(<span class="hljs-string">&quot;t2.txt&quot;</span>);
    XHRGet(<span class="hljs-string">&quot;t3.txt&quot;</span>);
}
</code></pre>
<p><code>XHRGet()</code> is implemented in JavaScript. The code of the import library is as follows:</p>
<pre><code class="lang-js"><span class="hljs-comment">//pkg1.js</span>
mergeInto(LibraryManager.library, {
    XHRGet: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url</span>) </span>{
        <span class="hljs-keyword">return</span> JS_XHRGet(Pointer_stringify(url));
    },
})
</code></pre>
<p><code>XHRGet()</code> calls the <code>JS_XHRGet()</code> function, which is located in &quot;xhr_wrap1.html&quot;:</p>
<pre><code class="lang-js"><span class="hljs-comment">//xhr_wrap1.html</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">JS_XHRGet</span>(<span class="hljs-params">url</span>) </span>{
        <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> XMLHttpRequest();
        request.open(<span class="hljs-string">&quot;GET&quot;</span>, url, <span class="hljs-literal">true</span>);
        request.responseType = <span class="hljs-string">&quot;text&quot;</span>;    
        request.url = url;
        request.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-keyword">if</span> (request.readyState == <span class="hljs-number">4</span>) {
                <span class="hljs-keyword">if</span> (request.status == <span class="hljs-number">200</span>) {
                    Module.ccall(<span class="hljs-string">&apos;XHROnMessage&apos;</span>, <span class="hljs-string">&apos;null&apos;</span>,
                        [<span class="hljs-string">&apos;string&apos;</span>, <span class="hljs-string">&apos;string&apos;</span>], [request.url, request.responseText]);
                }
                <span class="hljs-keyword">else</span>{
                    Module.ccall(<span class="hljs-string">&apos;XHROnError&apos;</span>, <span class="hljs-string">&apos;null&apos;</span>,
                        [<span class="hljs-string">&apos;string&apos;</span>, <span class="hljs-string">&apos;number&apos;</span>], [request.url, request.status]);
                }
            }
        };
        request.send();
    }
</code></pre>
<p>Compile with the following command:</p>
<pre><code>emcc  xhr_wrap1.cpp --js-library pkg1.js -s &quot;EXTRA_EXPORTED_RUNTIME_METHODS=[&apos;ccall&apos;]&quot; -o xhr_wrap1.js
</code></pre><p>Browse the page, the console outputs:</p>
<p><img src="images/01-xhr-wrap1.png" alt=""></p>
<p>It can be seen that the program correctly processed the return value, and <strong>because the asynchronous HTTP request is used, the order of return is not consistent with the order of the request</strong>.</p>
<h2 id="513-extending-callback">5.1.3 Extending callback</h2>
<p>Sometimes we have multiple objects in C++ that need to initiate HTTP requests, and each object handles return value in differently way. At this time, the wrap method in Section 5.1.2 will not meet the needs. Therefore, we need to improve it by referring to the method in Section 4.3. The C code is as follows:</p>
<pre><code class="lang-c"><span class="hljs-comment">//xhr_wrap2.cpp</span>
<span class="hljs-keyword">struct</span> XHR_CB;

<span class="hljs-comment">//imp by JavaScript, call by C:</span>
EM_PORT_API(<span class="hljs-keyword">void</span>) XHRGet(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, XHR_CB* cb);

<span class="hljs-comment">//XHR callback interface:</span>
<span class="hljs-keyword">class</span> CXHRCallbackInterface{
<span class="hljs-keyword">public</span>:
    CXHRCallbackInterface(){}
    <span class="hljs-keyword">virtual</span> ~CXHRCallbackInterface(){}

    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnMessage</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* data)</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnError</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> code)</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-comment">//XHR callback1:</span>
<span class="hljs-keyword">class</span> CXHRCallback1 : <span class="hljs-keyword">public</span> CXHRCallbackInterface{
<span class="hljs-keyword">public</span>:
    CXHRCallback1(){}
    <span class="hljs-keyword">virtual</span> ~CXHRCallback1(){}

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnMessage</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* data)</span> </span>{
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CXHRCallback1::OnMessage(); URL: %s  contex: %s\n&quot;</span>, url, data);
    }
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnError</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> code)</span> </span>{
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CXHRCallback1::OnError(); URL: %s  error code:%d\n&quot;</span>, url, code);
    }
};

<span class="hljs-comment">//XHR callback2:</span>
<span class="hljs-keyword">class</span> CXHRCallback2 : <span class="hljs-keyword">public</span> CXHRCallbackInterface{
<span class="hljs-keyword">public</span>:
    CXHRCallback2(){}
    <span class="hljs-keyword">virtual</span> ~CXHRCallback2(){}

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnMessage</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* data)</span> </span>{
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CXHRCallback2::OnMessage(); URL: %s  contex: %s\n&quot;</span>, url, data);
    }
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnError</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> code)</span> </span>{
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;CXHRCallback2::OnError(); URL: %s  error code:%d\n&quot;</span>, url, code);
    }
};

<span class="hljs-comment">//imp by C, call by JavaScript:</span>
EM_PORT_API(<span class="hljs-keyword">void</span>) XHROnMessage(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* data, XHR_CB* cb){
    CXHRCallbackInterface* ci = (CXHRCallbackInterface*)cb;
    ci-&gt;OnMessage(url, data);
}

EM_PORT_API(<span class="hljs-keyword">void</span>) XHROnError(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* url, <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> code, XHR_CB* cb){
    CXHRCallbackInterface* ci = (CXHRCallbackInterface*)cb;
    ci-&gt;OnError(url, code);
}

CXHRCallback1 cb1;
CXHRCallback2 cb2;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    XHRGet(<span class="hljs-string">&quot;t1.txt&quot;</span>, (XHR_CB*)&amp;cb1);
    XHRGet(<span class="hljs-string">&quot;t2.txt&quot;</span>, (XHR_CB*)&amp;cb2);
    XHRGet(<span class="hljs-string">&quot;t3.txt&quot;</span>, (XHR_CB*)&amp;cb2);
}
</code></pre>
<p>The JavaScript import library is as follows:</p>
<pre><code class="lang-js"><span class="hljs-comment">//xhr_wrap2.pkg</span>
mergeInto(LibraryManager.library, {
    XHRGet: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">url, cb</span>) </span>{
        <span class="hljs-keyword">return</span> JS_XHRGet(Pointer_stringify(url), cb);
    },
})
</code></pre>
<p>JavaScript code:</p>
<pre><code class="lang-js"><span class="hljs-comment">//xhr_wrap2.html</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">JS_XHRGet</span>(<span class="hljs-params">url, cb</span>) </span>{
        <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">new</span> XMLHttpRequest();
        request.open(<span class="hljs-string">&quot;GET&quot;</span>, url, <span class="hljs-literal">true</span>);
        request.responseType = <span class="hljs-string">&quot;text&quot;</span>;    
        request.url = url;
        request.wrap_cb = cb;
        request.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-keyword">if</span> (request.readyState == <span class="hljs-number">4</span>) {
                <span class="hljs-keyword">if</span> (request.status == <span class="hljs-number">200</span>) {
                    Module.ccall(<span class="hljs-string">&apos;XHROnMessage&apos;</span>, <span class="hljs-string">&apos;null&apos;</span>,
                        [<span class="hljs-string">&apos;string&apos;</span>, <span class="hljs-string">&apos;string&apos;</span>, <span class="hljs-string">&apos;number&apos;</span>],
                        [request.url, request.responseText, request.wrap_cb]);
                }
                <span class="hljs-keyword">else</span>{
                    Module.ccall(<span class="hljs-string">&apos;XHROnError&apos;</span>, <span class="hljs-string">&apos;null&apos;</span>,
                        [<span class="hljs-string">&apos;string&apos;</span>, <span class="hljs-string">&apos;number&apos;</span>, <span class="hljs-string">&apos;number&apos;</span>],
                        [request.url, request.status, request.wrap_cb]);
                }
            }
        };
        request.send();
    }
</code></pre>
<p>The core idea of the above code is that we bind a callback handler object <code>cb</code> for each <code>XHRGet()</code> request. When the HTTP request is completed, the bound <code>cb</code> object will be called to handle the event.</p>
<p>Compile with the following command:</p>
<pre><code>emcc xhr_wrap2.cpp --js-library pkg2.js -s &quot;EXTRA_EXPORTED_RUNTIME_METHODS=[&apos;ccall&apos;]&quot; -o xhr_wrap2.js
</code></pre><p>Browse the page, the console outputs:</p>
<p><img src="images/01-xhr-wrap2.png" alt=""></p>

                                
                                </section>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9312750344484857"
     data-ad-slot="1873149722"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="readme.html" class="navigation navigation-prev " aria-label="Previous page: Chapter 5 Network IO">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="ch5-02-websocket.html" class="navigation navigation-next " aria-label="Next page: 5.2 WebSocket">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"5.1 XMLHttpRequest","level":"1.6.1","depth":2,"next":{"title":"5.2 WebSocket","level":"1.6.2","depth":2,"path":"ch5-net/ch5-02-websocket.md","ref":"ch5-net/ch5-02-websocket.md","articles":[]},"previous":{"title":"Chapter 5 Network IO","level":"1.6","depth":1,"path":"ch5-net/readme.md","ref":"ch5-net/readme.md","articles":[{"title":"5.1 XMLHttpRequest","level":"1.6.1","depth":2,"path":"ch5-net/ch5-01-http.md","ref":"ch5-net/ch5-01-http.md","articles":[]},{"title":"5.2 WebSocket","level":"1.6.2","depth":2,"path":"ch5-net/ch5-02-websocket.md","ref":"ch5-net/ch5-02-websocket.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["-search"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-oebook":{"showLevel":false,"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"styles/website.css"}}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"preface.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"WebAssembly friendly programming with C/C++","language":"en","gitbook":"3.x","description":"WebAssembly friendly programming with C/C++ -- Emscripten practice"},"file":{"path":"ch5-net/ch5-01-http.md","mtime":"2021-06-13T12:23:26.945Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-06-13T12:24:00.613Z"},"basePath":"..","book":{"language":"en"}});
        });
    </script>
</div>

        
    <script src="//cdn.jsdelivr.net/npm/gitbook-plugin-theme-default@1.0.7/_assets/website/gitbook.js"></script>
    <script src="//cdn.jsdelivr.net/npm/gitbook-plugin-theme-default@1.0.7/_assets/website/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

